# CI/CD Scripts

Ця директорія містить скрипти для автоматизації процесів CI/CD в інформаційній системі управління бізнес-діяльністю підприємства.

## Скрипти

### migrate.js

Скрипт для міграції бази даних для всіх мікросервісів.

```bash
# Запуск міграцій для середовища розробки (за замовчуванням)
node migrate.js

# Запуск міграцій для тестового середовища
node migrate.js testing

# Запуск міграцій для виробничого середовища
node migrate.js production
```

### migration-status.js

Скрипт для перевірки статусу міграцій бази даних для всіх мікросервісів.

```bash
# Перевірка статусу міграцій для середовища розробки (за замовчуванням)
node migration-status.js

# Перевірка статусу міграцій для тестового середовища
node migration-status.js testing

# Перевірка статусу міграцій для виробничого середовища
node migration-status.js production
```

### migrate-rollback.js

Скрипт для відкату міграцій бази даних для всіх або конкретного мікросервісу.

```bash
# Відкат останньої міграції для всіх сервісів у середовищі розробки (за замовчуванням)
node migrate-rollback.js

# Відкат останньої міграції для конкретного сервісу
node migrate-rollback.js development auth-service

# Відкат декількох міграцій для конкретного сервісу
node migrate-rollback.js development auth-service 3

# Відкат міграцій для тестового середовища
node migrate-rollback.js testing

# Відкат міграцій для виробничого середовища
node migrate-rollback.js production
```

### db-maintenance.js

Скрипт для виконання операцій обслуговування бази даних PostgreSQL, включаючи VACUUM, ANALYZE, REINDEX та створення резервних копій.

```bash
# Виконання всіх операцій обслуговування для середовища розробки (за замовчуванням)
node db-maintenance.js

# Виконання конкретної операції обслуговування (vacuum, analyze, reindex, backup)
node db-maintenance.js development vacuum

# Виконання всіх операцій обслуговування для тестового середовища
node db-maintenance.js testing all

# Створення резервної копії бази даних для виробничого середовища
node db-maintenance.js production backup
```

### smoke-tests.js

Скрипт для запуску smoke-тестів, які перевіряють базову функціональність системи.

```bash
# Запуск тестів для середовища розробки (за замовчуванням)
node smoke-tests.js

# Запуск тестів для тестового середовища
node smoke-tests.js testing

# Запуск тестів для виробничого середовища
node smoke-tests.js production
```

### deploy.js

Скрипт для автоматичного розгортання на Railway з міграцією бази даних та smoke-тестами.

```bash
# Розгортання в середовище розробки (за замовчуванням)
node deploy.js

# Розгортання в тестове середовище
node deploy.js testing

# Розгортання в виробниче середовище
node deploy.js production
```

## Використання в CI/CD пайплайні

Ці скрипти використовуються в GitHub Actions для автоматизації процесів CI/CD. Вони викликаються на різних етапах пайплайну:

1. **migrate.js** - викликається після розгортання для оновлення структури бази даних
2. **smoke-tests.js** - викликається після міграції для перевірки базової функціональності
3. **deploy.js** - може використовуватися для ручного розгортання або в пайплайні

## Вимоги

Для роботи скриптів необхідно:

1. Node.js 18 або вище
2. Railway CLI (`npm install -g @railway/cli`)
3. Змінна середовища `RAILWAY_TOKEN` для доступу до Railway

## Налаштування

Скрипти автоматично використовують конфігурації середовищ з директорії `config/environments/`. Переконайтеся, що всі необхідні змінні середовища налаштовані правильно для кожного середовища.

## Усунення несправностей

### Помилки міграції

Якщо міграція не вдалася:

1. Перевірте логи міграції
2. Переконайтеся, що структура бази даних сумісна з новими міграціями
3. Перевірте підключення до бази даних

### Помилки smoke-тестів

Якщо smoke-тести не проходять:

1. Перевірте, чи всі сервіси запущені та доступні
2. Перевірте конфігурації середовища
3. Перевірте логи сервісів для виявлення помилок
